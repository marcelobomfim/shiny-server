---
title: "Ressignificando o Resultado do Tesouro Nacional"
resource_files:
- app.R
runtime: shiny
output:
  html_document: 
    code_folding: hide
    theme: cerulean
    toc: yes
    toc_float: yes
---

<!--code_folding -> mostra ou não o código do R-->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!--?cones podem ser achados no seguinte endere?o: https://www.w3schools.com/icons/fontawesome_icons_intro.asp-->

<style>
h1 {
  text-align:center
}
body {
  background-color: #FFFFFF;
  text-align:justify
}
</style>
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(magrittr)
```

```{r Funcoes}
source("Funcoes_analise_rtn.R")

```



```{r Carga_inicial, warning = FALSE, message = FALSE}

library(readxl)
#library(XLConnect)
library(tidyr)
library(RCurl)
library(ckanr)

ultima_carga<-""

load("todas_series.Rdata")

#tb_ckan<-resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",url="http://www.tesourotransparente.gov.br/ckan")

tb_ckan<-resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",url="https://apickan.tesouro.gov.br/ckan")


mudou<- (tb_ckan$last_modified!=ultima_carga)

#mudou<-FALSE


if (mudou){
  ultima_carga<- tb_ckan$last_modified
  URL_add <- tb_ckan$url
  
  URL_add<-gsub("https://www.tesourotransparente.gov.br","https://apickan.tesouro.gov.br",URL_add)
  
  tmp = paste(getwd(),"temp.xlsx")
  
  
  tmp = tempfile(fileext = ".xlsx")
  
  
  
  download.file(URL_add,mode = "wb", destfile = tmp)
  #rtn_geral <- read.xlsx(tmp, sheetIndex=2, rowIndex = c(5:79))
  rtn_geral <- read_xlsx(tmp,sheet = 2,skip = 4,n_max = 74)
  #rtn_receita<-read.xlsx(tmp, sheetIndex=4, rowIndex = c(5:53))
  rtn_receita<- read_xlsx(tmp,sheet = 4,skip = 4,n_max = 48)
  #rtn_despesa<- read.xlsx(tmp, sheetIndex=8, rowIndex = c(5:92))
  rtn_despesa<- read_xlsx(tmp,sheet = 8,skip = 4,n_max = 88)
  #deflator_IPCA <- read.xlsx(tmp,sheetIndex=5, rowIndex = c(55:55),header=FALSE) #vai ser sempre a última linha de receita + 2
  deflator_IPCA <- read_xlsx(tmp,sheet = 5,skip = 54,n_max = 1, col_names = FALSE)
  names(deflator_IPCA)<-names(rtn_receita)
  
  

  names(rtn_geral)[1]<-"Rubrica"
  series_temporais_analise<-gather(rtn_geral,Data, Valor,-Rubrica)
  #series_temporais_analise$Data<-gsub("X","",series_temporais_analise$Data)
  series_temporais_analise$Data<-as.Date(as.numeric(series_temporais_analise$Data), origin="1899-12-30")
  series_temporais_analise$Valor <-as.numeric(series_temporais_analise$Valor)
  series_temporais_analise$Valor[is.na(series_temporais_analise$Valor)]<-0
  rm(rtn_geral)
  
  
  names(rtn_receita)[1]<-"Rubrica"
  series_temporais_analise_rec<-gather(rtn_receita,Data, Valor,-Rubrica)
  #series_temporais_analise_rec$Data<-gsub("X","",series_temporais_analise_rec$Data)
  series_temporais_analise_rec$Data<-as.Date(as.numeric(series_temporais_analise_rec$Data), origin="1899-12-30")
  series_temporais_analise_rec$Valor <-as.numeric(series_temporais_analise_rec$Valor)
  series_temporais_analise_rec$Valor[is.na(series_temporais_analise_rec$Valor)]<-0
  rm(rtn_receita)
  
  names(rtn_despesa)[1]<-"Rubrica"
  series_temporais_analise_desp<-gather(rtn_despesa,Data, Valor,-Rubrica)
  #series_temporais_analise_desp$Data<-gsub("X","",series_temporais_analise_desp$Data)
  series_temporais_analise_desp$Data<-as.Date(as.numeric(series_temporais_analise_desp$Data), origin="1899-12-30")
  series_temporais_analise_desp$Valor <-as.numeric(series_temporais_analise_desp$Valor)
  series_temporais_analise_desp$Valor[is.na(series_temporais_analise_desp$Valor)]<-0
  rm(rtn_despesa)
  
  names(deflator_IPCA)[1]<-"Rubrica"
  series_temporais_analise_IPCA<-gather(deflator_IPCA,Data, Valor,-Rubrica)
  #series_temporais_analise_IPCA$Data<-gsub("X","",series_temporais_analise_IPCA$Data)
  series_temporais_analise_IPCA$Data<-as.Date(as.numeric(series_temporais_analise_IPCA$Data), origin="1899-12-30")
  series_temporais_analise_IPCA$Valor <-as.numeric(series_temporais_analise_IPCA$Valor)
  rm(deflator_IPCA)
  
  URL_add<-"https://apickan.tesouro.gov.br/ckan/dataset/ab56485b-9c40-4efb-8563-9ce3e1973c4b/resource/7a535375-4e15-4ebb-bb49-25daf05330bb/download/Metadados---NFGC.xlsx"
  
  tmp = paste(getwd(),"temp.xlsx")
  
  
  tmp = tempfile(fileext = ".xlsx")
  
  download.file(URL_add,mode = "wb", destfile = tmp)


  #metadados_rec<- read.xlsx(tmp, sheetIndex=4, startRow = 5, colIndex = c(2,3))
  metadados_rec<-read_xlsx(tmp,sheet = 4,skip =4)
  metadados_rec <- metadados_rec[,c(2,3)]
  #metadados_desp<-read.xlsx(tmp, sheetIndex=8, startRow = 5, colIndex = c(1,2))
  metadados_desp<-read_xlsx(tmp,sheet = 8,skip =4)
  metadados_desp <- metadados_desp[,c(1,2)]
  
  names(metadados_rec)<-c("Rubrica","Descricao")
  names(metadados_desp) <- names(metadados_rec)

  
  
  
  save(list = c("metadados_rec","metadados_desp","series_temporais_analise_IPCA", "series_temporais_analise_desp","series_temporais_analise_rec","series_temporais_analise","ultima_carga" ),file = "todas_series.Rdata")
  rm(series_temporais_analise)
  

}

# library(xlsx)
# library(XLConnect)
# library(tidyr)
# library(RCurl)
# library(ckanr)
# 
# ultima_carga<-""
# 
# load("todas_series.Rdata")
# 
# #tb_ckan<-resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",url="http://www.tesourotransparente.gov.br/ckan")
# 
# tb_ckan<-resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",url="https://apickan.tesouro.gov.br/ckan")
# 
# 
# mudou<- (tb_ckan$last_modified!=ultima_carga)
# 
# #mudou<-FALSE
# 
# 
# if (mudou){
#   ultima_carga<- tb_ckan$last_modified
#   URL_add <- tb_ckan$url
#   
#   URL_add<-gsub("https://www.tesourotransparente.gov.br","https://apickan.tesouro.gov.br",URL_add)
#   
#   tmp = paste(getwd(),"temp.xlsx")
#   
#   
#   tmp = tempfile(fileext = ".xlsx")
#   
#   
#   
#   download.file(URL_add,mode = "wb", destfile = tmp)
#   rtn_geral <- read.xlsx(tmp, sheetIndex=2, rowIndex = c(5:79))
#   rtn_receita<-read.xlsx(tmp, sheetIndex=4, rowIndex = c(5:53))
#   rtn_despesa<- read.xlsx(tmp, sheetIndex=8, rowIndex = c(5:92))
#   deflator_IPCA <- read.xlsx(tmp,sheetIndex=5, rowIndex = c(55:55),header=FALSE) #vai ser sempre a última linha de receita + 2
#   names(deflator_IPCA)<-names(rtn_receita)
#   
#   
# 
#   names(rtn_geral)[1]<-"Rubrica"
#   series_temporais_analise<-gather(rtn_geral,Data, Valor,-Rubrica)
#   series_temporais_analise$Data<-gsub("X","",series_temporais_analise$Data)
#   series_temporais_analise$Data<-as.Date(as.numeric(series_temporais_analise$Data), origin="1899-12-30")
#   series_temporais_analise$Valor <-as.numeric(series_temporais_analise$Valor)
#   series_temporais_analise$Valor[is.na(series_temporais_analise$Valor)]<-0
#   rm(rtn_geral)
#   
#   
#   names(rtn_receita)[1]<-"Rubrica"
#   series_temporais_analise_rec<-gather(rtn_receita,Data, Valor,-Rubrica)
#   series_temporais_analise_rec$Data<-gsub("X","",series_temporais_analise_rec$Data)
#   series_temporais_analise_rec$Data<-as.Date(as.numeric(series_temporais_analise_rec$Data), origin="1899-12-30")
#   series_temporais_analise_rec$Valor <-as.numeric(series_temporais_analise_rec$Valor)
#   series_temporais_analise_rec$Valor[is.na(series_temporais_analise_rec$Valor)]<-0
#   rm(rtn_receita)
#   
#   names(rtn_despesa)[1]<-"Rubrica"
#   series_temporais_analise_desp<-gather(rtn_despesa,Data, Valor,-Rubrica)
#   series_temporais_analise_desp$Data<-gsub("X","",series_temporais_analise_desp$Data)
#   series_temporais_analise_desp$Data<-as.Date(as.numeric(series_temporais_analise_desp$Data), origin="1899-12-30")
#   series_temporais_analise_desp$Valor <-as.numeric(series_temporais_analise_desp$Valor)
#   series_temporais_analise_desp$Valor[is.na(series_temporais_analise_desp$Valor)]<-0
#   rm(rtn_despesa)
#   
#   names(deflator_IPCA)[1]<-"Rubrica"
#   series_temporais_analise_IPCA<-gather(deflator_IPCA,Data, Valor,-Rubrica)
#   series_temporais_analise_IPCA$Data<-gsub("X","",series_temporais_analise_IPCA$Data)
#   series_temporais_analise_IPCA$Data<-as.Date(as.numeric(series_temporais_analise_IPCA$Data), origin="1899-12-30")
#   series_temporais_analise_IPCA$Valor <-as.numeric(series_temporais_analise_IPCA$Valor)
#   rm(deflator_IPCA)
#   
#   URL_add<-"https://apickan.tesouro.gov.br/ckan/dataset/ab56485b-9c40-4efb-8563-9ce3e1973c4b/resource/7a535375-4e15-4ebb-bb49-25daf05330bb/download/Metadados---NFGC.xlsx"
#   
#   tmp = paste(getwd(),"temp.xlsx")
#   
#   
#   tmp = tempfile(fileext = ".xlsx")
#   
#   download.file(URL_add,mode = "wb", destfile = tmp)
# 
# 
#   metadados_rec<- read.xlsx(tmp, sheetIndex=4, startRow = 5, colIndex = c(2,3))
#   metadados_desp<-read.xlsx(tmp, sheetIndex=8, startRow = 5, colIndex = c(1,2))
#   names(metadados_rec)<-c("Rubrica","Descricao")
#   names(metadados_desp) <- names(metadados_rec)
# 
#   
#   
#   
#   save(list = c("metadados_rec","metadados_desp","series_temporais_analise_IPCA", "series_temporais_analise_desp","series_temporais_analise_rec","series_temporais_analise","ultima_carga" ),file = "todas_series.Rdata")
#   rm(series_temporais_analise)
#   
# 
# }

```




# Visão Geral
Os diversos governos no mundo todo, seja no nível de municípos, estados ou países, executam suas ações dentro daquilo que cada população entende como obrigação do Estado. Essas ações implicam necessariamente em despesas que são por sua vez custeadas por diversos tipos de receitas. Os impactos positivos ou negativos da priorização das despesas e consequentemente alocação das receitas é consequências das políticas públicas que são de alguma forma priorizadas.

Para além do impacto das políticas públicas, a gestão dessas entradas e saídas de recursos costuma também impactar questões econômicas, que podem atingir direta ou indiretamente os cidadãos, as empresas e as relaçoes entre os governos, por exemplo. Destaca-se entre essas questões os juros, a inflação e a dívida. 

Seja por entender as priorizações de políticas públicas, seja para ficar atento aos impactos da gestão das finanças públicas, parece ser interessante acompanhar a evolução das receitas e despesas de um governo. Esse é o objetivo desse aplicativo: fornecer informações para melhor compreensão dos fluxos de entrada e saída de recursos e trazer alugmas primeiras análises mais avançadas para fomentar o debate, a participação social e o controle social sobre as finanças públicas do governo central brasileiro, que compreende o poder executivo, legislativo e judiciário federais.


# Resultado Primário

O instrumento que este aplicativo utiliza para apresentar conceitos e fomentar debate é o chamado Resultado do Tesouro Nacional (RTN). Trata-se de uma consolidação de informações de receitas e despesas do governo central brasileiro feita mensalmente pela Secretaria do Tesouro Nacional (STN). 

Para fins desse relatório, não são incluídas as receitas e despesas com juros e por conta disso, há uma adequação a uma terminologia onde as receitas são reconhecidas como receitas primárias, as despesas como despesas primárias e a diferença entre receita primária e despesa primária é o chamado resultado primário.

Quando as receitas primárias superam as despesas primárias há o chamado superávit primário e quando ocorre o contrário, entende-se que ocorre déficit primário.

É bem provável que você já tenha ouvido falar bastante desses termos. Eles são comuns nos debates econômicos e estão associados a metas que os governos precisam atingir. Veja abaixo o resultado de algumas buscas feitas na internet sobre esses termos.



[Resultados de pesquisa para Resultado Primário](https://www.google.com.br/search?q=%22Resultado+Primario%22&dcr=0&source=lnms&sa=X&ved=0ahUKEwjQtJ_a0pbaAhUFIpAKHRgHB4AQ_AUICSgA&biw=1366&bih=641&dpr=1)

[Resultados de pesquisa para Superávit Primário](https://www.google.com.br/search?dcr=0&biw=1366&bih=641&ei=Xou_WrLmNc65wgTmqrj4CA&q=%22superavit+primario%22&oq=%22super%C3%A1vit+prim%C3%A1rio%22&gs_l=psy-ab.3..0i22i30k1l10.62762.69335.0.70388.7.7.0.0.0.0.122.678.0j6.6.0..2..0...1.1.64.psy-ab..1.6.675...0j0i7i30k1.0.iQFt_ZRqWwo)

[Resultados de pesquisa para Déficit Primário](https://www.google.com.br/search?dcr=0&biw=1366&bih=641&ei=aoy_Wvn8A4KkwASfoJeQBQ&q=%22deficit+primario%22&oq=%22d%C3%A9ficit+prim%C3%A1rio%22&gs_l=psy-ab.12...0.0.0.133647.0.0.0.0.0.0.0.0..0.0....0...1..64.psy-ab..0.0.0....0.QtVBKkUusLI)

```{r}

# library(shiny)
# # Simple shiny layout for demo sake
# shinyApp(
#   
#   ui = fluidPage({
#       htmlOutput("RP")
# }),
# server = function(input, output) {
#   output$RP <- renderUI({
#     
#     
# 
#     #HTML(fab)
#     HTML(readLines('https://www.google.com.br/search?q=%22Resultado+Primario%22&dcr=0&source=lnms&sa=X&ved=0ahUKEwjQtJ_a0pbaAhUFIpAKHRgHB4AQ_AUICSgA&biw=1366&bih=641&dpr=1'))
#     
#   })  
# },
#  
#   options = list(height = 400)
# )
# 
  
```




## Análise do Resultado Primário 
Como já foi dito o resultado primário trata-se da diferença entre receitas e despesas primárias, Quando essa diferença positiva, tem-se um superávit primário e no caso contrário um défict primário.
Pela estrutura do RTN, o Resultado Primário é calculado pela seguinte fórmula:

$$ RP = RL - DT + FSB $$
Onde: </BR>
RP = Resultado Primário </BR>
RL = Receita Líquida </BR>
DT = Despesa Total </BR>
FSB = Resultado do Fundo Soberano do Brasil </BR>

O gráfico abaixo mostra a evolução das séries relacionadas à fórmula do Resultado Primário. Observe o comportamento da série RP, procurando identificar os pontos onde os valores são positivos e negativos. Para esses pontos busque os valores das séries RL e DT, principalmente para verificar como a diferença entre essas duas séries está gerando superávits e déficits primários.
Experimente mover as setas abaixo do gráfico para esquerda ou para direita para analisar com mais foco algum período específico.
Antes de começar a usar o gráfico, uma observação importante, a menos que se expresse o contrário, todas os valores apresentados neste aplicativo são expressos em milhões de reais.

```{r Tabela_resultado_primario, fig.width=8, fig.height=6}

#######################Melhorar
# 1- Implementar função que faça a carga das rubricas a partir de uma lista hierárquica

load("todas_series.Rdata")
serie_trabalho <- series_temporais_analise[grep("VI. PRIM",series_temporais_analise$Rubrica),]
serie_trabalho <- rbind(serie_trabalho,series_temporais_analise[grep("III. RECEITA",series_temporais_analise$Rubrica),])
serie_trabalho <- rbind(serie_trabalho,series_temporais_analise[grep("IV. DESPESA TOTAL",series_temporais_analise$Rubrica),])
serie_trabalho <- rbind(serie_trabalho,series_temporais_analise[grep("V. FUNDO SOBERANO DO BRASIL",series_temporais_analise$Rubrica),])

rm(series_temporais_analise) 

ano_fim<-as.numeric(substr(serie_trabalho$Data[NROW(serie_trabalho)],1,4))
mes_fim<-as.numeric(substr(serie_trabalho$Data[NROW(serie_trabalho)],6,7))
ts_serie_trabalho_prim <- ts(serie_trabalho$Valor[grep("VI. PRIM",serie_trabalho$Rubrica)],start = c(1997,1),end = c(ano_fim,mes_fim),frequency = 12)
ts_serie_trabalho_rec  <- ts(serie_trabalho$Valor[grep("III. RECEITA",serie_trabalho$Rubrica)],start = c(1997,1),end = c(ano_fim,mes_fim),frequency = 12)
ts_serie_trabalho_desp  <- ts(serie_trabalho$Valor[grep("IV. DESPESA TOTAL",serie_trabalho$Rubrica)],start = c(1997,1),end = c(ano_fim,mes_fim),frequency = 12)
ts_serie_trabalho_fsb  <- ts(serie_trabalho$Valor[grep("V. FUNDO SOBERANO DO BRASIL",serie_trabalho$Rubrica)],start = c(1997,1),end = c(ano_fim,mes_fim),frequency = 12)
ts_serie_trabalho_fsb[ts_serie_trabalho_fsb==0]<-NA
save(list = "serie_trabalho",file = "serie_trabalho_prim.Rdata")
y_min <- min(as.numeric(serie_trabalho$Valor))
y_max <- max(as.numeric(serie_trabalho$Valor))
rm(serie_trabalho)
series <-cbind(ts_serie_trabalho_prim,ts_serie_trabalho_rec,ts_serie_trabalho_desp,ts_serie_trabalho_fsb)

library(dygraphs) #Série temporal dinâmica



dygraph(series,main = "Resultado Primário - Governo central") %>%
  dyRangeSelector() %>%
  dyAxis(name= "y",valueRange = c(y_min,y_max)) %>%
  dySeries(label = "RP") %>%
  dySeries(label = "RL") %>%
  dySeries(label = "DT") %>%
  dySeries(label = "FSB") %>%
  dyLegend(show = "always", hideOnMouseOut = TRUE, width = 400)%>%
  dyOptions( drawGrid = FALSE)%>%
  dyHighlight(highlightCircleSize = 5)
  #connectSeparatedPoints = TRUE,

```

</br>
Como pode ser observado no gráfico, ocoreram superávits primários em  Novembro de 2013 e em Outubro de 2017, por exemplo. Nota-se nesses casos que a Receita Líquida foi superior à Despesa Total, enquanto que o valor do fluxo de Fundo Soberano estava zerado. O contrário ocorreu, por exemplo, em Agosto de 2014 e Setembro de 2017, gerando dessa forma déficits primários.


A série completa do Resultado Primário e de seus componentes desde Janeiro de 1997 pode ser baixada a partir do link abaixo
```{r}
load("serie_trabalho_prim.Rdata")
write.csv2(serie_trabalho, "./file.csv")

library(magrittr)
readLines("./file.csv") %>%
  paste0(collapse="\n") %>%
  openssl::base64_encode() -> encoded
rm(serie_trabalho)

#Monta_Arquivo_CSV(serie_trabalho)
```


<a download="file.csv" href="`r sprintf('data:text/csv;base64,%s', encoded)`">Download CSV</a>
</br>

Você também pode ver as séries RP, RL, DT de forma separada a partir do painel abaixo. </br>
```{r}


library(shiny)
library(tableHTML)
load("todas_series.Rdata")
shinyApp(
  ui = fluidPage(
  tags$style(make_css(list('.dygraph-legend', 
                             
                          c('left', 'background-color'), 
                          c('70px !important', 'opaque !important')))),

        sidebarPanel(
      selectInput("rubrica", "Rubricas",
                  choices = c("Resultado Primário"= "VI. PRIM",
                              "Receita Líquida" = "III. RECEITA",
                              "Despesa Total" = "IV. DESPESA TOTAL")
      ),
      radioButtons("tipoValor", "Tipo Valor",
                  choices = c("Indexado IPCA"="2",
                              "Nominal"= "1")),
      radioButtons("tipoPeriodo", "Mensal acumulado por",
                  choices = c("12 meses"="12",
                              "Mês"= "m",
                              "Trimestre"="t",
                              "Ano" ="a"))
      
    ),
    
    mainPanel(
      dygraphOutput("Grafico_selecao_usuario")
    )
    
  ),
  
  server = function(input, output) {
    output$Grafico_selecao_usuario <- renderDygraph({
      Grafico_selecao_usuario(series_temporais_analise,
                    input$tipoValor,
                    input$tipoPeriodo,
                    input$rubrica,
                    input$rubrica,
                    "Análise Resultado Primário",
                    TRUE)
    })
  },
  
  options = list(height = 500)
)



```

Observe no painel acima que você pode ver os dados na opção de valores nominais ou indexado pelo IPCA. A primeira opção refere-se ao valor registrado na época em que foi apurado, enquanto que a segunda opção mostra valores corrigidos por um índice que mede a inflação. Dessa forma, essa segunda opção tira os efeitos da inflação sobre os dados analisados.

Ainda é importante observar que a consulta permite que se veja os valores mensais sem nenhum acúmulo, valores que mostram o valor acumulado em doze meses,valores acumulados em um ano e valores acumulados em um trimestre.
Experimente refazer a consulta combinando as diversas opções disponíveis e veja o efeito resultante no gráfico.


# Receitas Primárias

Uma vez apresentado o conceito de Resultado Primário e a sua fórmula, é interessante conhecer quais são exatamente as receitas e despesas que entram no cálculo desse indicador fiscal. Nesta seção explora-se as receitas primárias. A seção seguinte será focada nas despesas primárias.

Em qualquer análise sobre economia, contabilidade e finanças é importante conhecer como as informações são organizadas. Geralmente ocorre a formação de uma hierarquia onde os valores vão sendo aglutinados de acordo com alguma lógica de organização. No caso das receitas, a primeira hierarquia a ser tratada é a que resulta na Receita Líquida. Esta é o resultado do total da Receita arrecadada, excluídas as chamadas transferências, que são receitas apuradas pelo governo central que precisam ser repassadas principalmente para estados e municípios. 

Para melhorar a organização desses conceitos e unificar a linguagem há uma codificação para todos os elementos que compõem o RTN, até agora já abordamos os seguintes códigos:

I. Receita Total

II. Transferência por Repartição de Receitas

III. Receita Lìquida

A receita total é formada por outros elementos que vão compor a sua hierarquia, esses outros elementos também são resultados de uma composição de elementos e essa estrutura vai se acumulando até chegarmos nas chamadas receitas de movimento que não são resultados de nenhuma aglutinação. Abaixo um exemplo dessa estrutura

I. Receita Total

I.1 -  Receita Administrada pela RFB

I.1.1    Imposto de Importação

I.1.2    IPI

I.1.2.1    IPI - Fumo

I.1.2.2    IPI - Bebidas

I.1.2.3    IPI - Automóveis

I.1.2.4    IPI - Vinculado a importação

I.1.2.5    IPI - Outros

Para a hierarquia ilustrada acima, todas as réceitas cujos códigos começam com I.1.2 (I.1.2.1    IPI - Fumo, I.1.2.2    IPI - Bebidas, I.1.2.3    IPI - Automóveis, I.1.2.4    IPI - Vinculado a importação, I.1.2.5    IPI - Outros) são receitas de movimento e seus valores são somados para formar o valor da receita I.1.2    IPI.

No painel abaixo você pode acompanhar acompanhar a evolução histórica do valor de uma ou mais receitas, seja de movimento ou aglutinadora. Para tanto basta selecionar uma ou mais receitas. Clique ao lado de Receita Total para ter acesso a toda a lista de receitas. Escolha as que você deseja explorar. Para excluir alguma receita do gráfico basta clicar sobre o nome e pressionar a tecla del. Você pode já ir fazendo algumas consultas e logo adiante será explicado como explorar melhor esse painel.

```{r}
library(knitr)

library(shiny)
library(dygraphs)
library(data.table)
library(plotly)
library(tableHTML)
#library(future)
#library(promises)
#plan(multiprocess)
load("todas_series.Rdata")
shinyApp(
  
  ui = fluidPage(
    tags$style(make_css(list('.dygraph-legend', 
                             
                          c('left', 'background-color'), 
                          c('70px !important', 'opaque !important')))),
    sidebarLayout(
      sidebarPanel(
        selectInput("rubrica", "Rubricas",
                    choices = unique(series_temporais_analise_rec$Rubrica),
                    multiple = TRUE,            
                    selected = series_temporais_analise_rec$Rubrica[1]
        ),
        radioButtons("tipoValor", "Tipo Valor",
                     choices = c("Indexado IPCA"="2",
                                 "Nominal"= "1")),
        radioButtons("tipoPeriodo", "Tipo Período",
                     choices = c("Acumulado 12 meses"="12",
                                 "Mensal"= "m",
                                 "Trimeste"="t",
                                 "Ano" ="a")),
        selectInput("data_sel", "Data Seleção",
                    choices = unique( format(series_temporais_analise_rec$Data,"%d/%m/%Y")),
                    multiple = FALSE,            
                    selected = format(max(series_temporais_analise_rec$Data),"%d/%m/%Y")
        ),
        downloadButton("downloadData", "Download")
        
      ),
      
      mainPanel(
        tabsetPanel(
          tabPanel("Gráfico",dygraphOutput("Grafico_selecao_usuario"),  width = "100%"),
          tabPanel("Metadados",DT::dataTableOutput("Visualiza_Metadados")))
      ) 
      
      
    ),
    
        tabsetPanel(
          tabPanel("Relatório RTN",htmlOutput("Visualiza_Relatorio", inline = TRUE),  width = "100%"),
          tabPanel("Gráfico de Distribuição",plotlyOutput("Grafico_Distribuicao"),  width = "100%")
        )
    
    
  ),
  
  server = function(input, output,session) {
    

    primeira_vez<-TRUE
    
    clicked <- reactive({
      req(input$Grafico_selecao_usuario_click$x)
    })
    
    observeEvent(clicked(),{
      print(paste("clicked",as.character(clicked())))
      s<-strptime(as.character(clicked()), "%Y-%m-%d")
      
      s<-format(s,"%d/%m/%Y")
      print(paste("s depois",s))
      updateSelectInput(session,"data_sel",selected = s)
    })

    
    output$Grafico_selecao_usuario <- renderDygraph({
      Grafico_selecao_usuario(series_temporais_analise_rec,
                              input$tipoValor,
                              input$tipoPeriodo,
                              input$rubrica,
                              input$rubrica,
                              "Análise Receitas",
                              FALSE)
    })
    output$Visualiza_Metadados <- DT::renderDataTable({
      Visualiza_Metadados(input$rubrica,1)
    })
   
        

   output$Visualiza_Relatorio <- renderUI({
     
      data_sel<- strptime(input$data_sel,  "%d/%m/%Y")
      data_sel<- format(data_sel, "%Y-%m-%d")
      tags$iframe(style="height:1000px; width:100%; scrolling=yes",
                  src=Busca_URL_Relatorio(data_sel))
     
      # promise<-future(req(input$Grafico_selecao_usuario_click$x))
      # if (substr(as.character(promise$value),1,5)=="Error"){
      #   data_sel<-max(series_temporais_analise_desp$Data)
      #   tags$iframe(style="height:1000px; width:100%; scrolling=yes",
      #             src=Busca_URL_Relatorio(data_sel))
      # 
      # } else
      # {
      #   data_sel<- strftime(as.character(promise$value), "%Y-%m-%d")
      #   tags$iframe(style="height:1000px; width:100%; scrolling=yes",
      #             src=Busca_URL_Relatorio(data_sel))
      # }

    })
   
    output$downloadData <- downloadHandler(
      filename = function() {
        
        paste("Receitas-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        Monta_Arquivo_CSV(series_temporais_analise_rec,
                          input$tipoValor,
                          input$tipoPeriodo,
                          input$rubrica,
                          FALSE,
                          file)
      }
    )
    
    
    output$Grafico_Distribuicao<- renderPlotly({
      print(paste("Antes ",input$data_sel))
      data_sel_rec<- strptime(input$data_sel,  "%d/%m/%Y")
      data_sel_rec<- format(data_sel_rec, "%Y-%m-%d")

      print(paste("Depois ",data_sel_rec))


            
      # if (substr(as.character(promise$value),1,5)=="Error"){
      #   
      #   data_sel_rec<-max(series_temporais_analise_rec$Data)
      # } else 
      # {
      #   
      #   data_sel_rec<-  strftime(as.character(req(input$Grafico_selecao_usuario_click$x)), "%Y-%m-%d")
      # }

      if (input$tipoPeriodo=="a" && substr(data_sel_rec,6,7)!="01"){
          return()
      }
          
      if (input$tipoPeriodo=="t" && !substr(data_sel_rec,6,7)%in%c("01","04","07","10")){
          return()
      }
        
      Visualizar_Grafico_Distribuicao (1, #1 - receita, 2- despesa, 3 transferências 
                                       input$tipoValor,
                                       input$tipoPeriodo,
                                       input$rubrica,
                                       FALSE,
                                       data_sel_rec,
                                       height = 500)

    })



  },
  
  options = list(height = 1000)
)

```


<img style="float: left;" src="exlamation.svg">
</br></br>*Se a aba **Relatório RTN** não apresentar conteúdo, clique [aqui](https://www.tesourotransparente.gov.br/ckan/dataset/343739de-7560-47af-8a0e-d51b363ec273/resource/05b300cf-8740-45bf-91f4-9249f1aa01bc/download/Nimjan2018.pdf) e indique que deseja abrir o arquivo mesmo com a exceção do certificado. Em seguida retorne para a aplicação*


</br></br></br>À medida que você seleciona as receitas as curvas são exibidas na aba **Gráfico**. A montagem do grávico leva ainda em consideração a seleção que você tenha feito sobre valores nominais ou valores indexados pelo IPCA e o tipo de período. Essas opções já foram explicadas mais acima.

É interessante notar que ao lado da aba **Gráfico** existe a aba **Metadados** essa aba contem explicações detalhadas sobre cada uma receitas selecionadas.

Mais abaixo das abas **Gráfico** e **Metadados** existem as abas **Relatório RTN** e **Gráfico de distribuição**. A aba **Relatório RTN** mostra o relatório produzido pela STN com as análises feitas sobre as variações de receitas, depesas e resultado primário para um mês selecionado. Para selecionar um mês basta clicar com o mouse no gráfico da aba **Receitas** sobre um ponto da curva que se deseja explorar melhor. Ao fazer isso será disponibilidade imediatamente o relatório referente àquele mês.

Essa seleção também permitirá entender como a receita total está distribuída entre as receitas de movimento para o mês selecionado. Essa informação estará presentes na aba **Gráfico de distribuição**. Esse gráfico além de mostrar a dsitribuição percentual da participação de cada receita de movimento sobre a Receita Total, destaca as receitas que foram selecionadas. Caso tenha sido selecionada uma receita aglutinadora, serão destacadas as receitas de movimento que formam a receita selecionada.

Experimente uma consulta direcionada. Selecione **I.1.3    Imposto de Renda**, na opção mensal com valores nominais. Observe o gráfico que é formado e veja um valor bem mais elevado do que os demais em Outubro de 2016. Clique nesse ponto do gráfico. Observe que a aba  **Relatório RTN** já traz o documento referente à data escolhida. Faça uma leitura e busque entender o que gerou esse valor tão diferenciado.


Em seguida navegue até a aba **Gráfico de distribuição** e visualize a contribuição percentual de cada receita de movimento para a Receita Total. Além disso perceba que esão destacadas as receitas de movimento que se aglutinam para formar **I.1.3    Imposto de Renda**.

Ainda no painel vale destacar o botão de download. Utilize-o para baixar em seu ambiente computacional os dados que foram visualizados no gráfico e faça outras análises usando suas próprias ferramentas.



# Despesas primárias

Toda a lógica de organização da informação das receitas primárias é válida para as despesas primárias. Também tudo que foi explicado sobre o funcionamento do painel de exploração de receitas primárias é válido para o painel de despesas primárias. Portanto, fique à vontade para explorar informações sobre as despesas primárias.

```{r}

library(knitr)

library(shiny)
library(dygraphs)
library(data.table)
library(plotly)
library(tableHTML)
load("todas_series.Rdata")
shinyApp(
  
  ui = fluidPage(
    tags$style(make_css(list('.dygraph-legend', 
                             
                          c('left', 'background-color'), 
                          c('70px !important', 'opaque !important')))),
    sidebarLayout(
      sidebarPanel(
        selectInput("rubrica", "Rubricas",
                    choices = unique(series_temporais_analise_desp$Rubrica),
                    multiple = TRUE,            
                    selected = series_temporais_analise_desp$Rubrica[1]
        ),
        radioButtons("tipoValor", "Tipo Valor",
                     choices = c("Indexado IPCA"="2",
                                 "Nominal"= "1")),
        radioButtons("tipoPeriodo", "Tipo Período",
                     choices = c("Acumulado 12 meses"="12",
                                 "Mensal"= "m",
                                 "Trimeste"="t",
                                 "Ano" ="a")),
        selectInput("data_sel", "Data Seleção",
                    choices = unique( format(series_temporais_analise_desp$Data,"%d/%m/%Y")),
                    multiple = FALSE,            
                    selected = format(max(series_temporais_analise_desp$Data),"%d/%m/%Y")
        ),
        downloadButton("downloadData", "Download")
        
      ),
      
      mainPanel(
        tabsetPanel(
          tabPanel("Gráfico",dygraphOutput("Grafico_selecao_usuario"),  width = "100%"),
          tabPanel("Metadados",DT::dataTableOutput("Visualiza_Metadados")))
      ) 
      
      
    ),
    
        tabsetPanel(
          tabPanel("Relatório RTN",htmlOutput("Visualiza_Relatorio", inline = TRUE),  width = "100%"),
          tabPanel("Gráfico de Distribuição",plotlyOutput("Grafico_Distribuicao"),  width = "100%")
        )
    
    
  ),
  
  server = function(input, output,session) {
    clicked <- reactive({
      req(input$Grafico_selecao_usuario_click$x)
    })
    
    observeEvent(clicked(),{
      print(paste("clicked",as.character(clicked())))
      s<-strptime(as.character(clicked()), "%Y-%m-%d")
      
      s<-format(s,"%d/%m/%Y")
      print(paste("s depois",s))
      updateSelectInput(session,"data_sel",selected = s)
    })
    
    output$Grafico_selecao_usuario <- renderDygraph({
      Grafico_selecao_usuario(series_temporais_analise_desp,
                              input$tipoValor,
                              input$tipoPeriodo,
                              input$rubrica,
                              input$rubrica,
                              "Análise Despesa",
                              FALSE)
    })
    output$Visualiza_Metadados <- DT::renderDataTable({
      Visualiza_Metadados(input$rubrica,2)#2 despesa
    })
    output$Visualiza_Relatorio <- renderUI({
      
      data_sel<- strptime(input$data_sel,  "%d/%m/%Y")
      data_sel<- format(data_sel, "%Y-%m-%d")
      tags$iframe(style="height:1000px; width:100%; scrolling=yes",
                  src=Busca_URL_Relatorio(data_sel))      
      
      # promise<-future(req(input$Grafico_selecao_usuario_click$x))
      # if (substr(as.character(promise$value),1,5)=="Error"){
      #   data_sel<-max(series_temporais_analise_desp$Data)
      #   tags$iframe(style="height:1000px; width:100%; scrolling=yes", 
      #             src=Busca_URL_Relatorio(data_sel))
      # 
      # } else
      # {
      #   data_sel<- strftime(as.character(promise$value), "%Y-%m-%d")
      #   tags$iframe(style="height:1000px; width:100%; scrolling=yes", 
      #             src=Busca_URL_Relatorio(data_sel))  
      # }
      
    })
    output$downloadData <- downloadHandler(
      filename = function() {
        
        paste("Despesas-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        Monta_Arquivo_CSV(series_temporais_analise_desp,
                          input$tipoValor,
                          input$tipoPeriodo,
                          input$rubrica,
                          FALSE,
                          file)
      }
    )

    output$Grafico_Distribuicao<- renderPlotly({
      print(paste("Antes ",input$data_sel))
      data_sel<- strptime(input$data_sel,  "%d/%m/%Y")
      data_sel<- format(data_sel, "%Y-%m-%d")
      
      # promise<-future(req(input$Grafico_selecao_usuario_click$x))
      # if (substr(as.character(promise$value),1,5)=="Error"){
      #   data_sel<-max(series_temporais_analise_rec$Data)
      # } else
      # {
      #   data_sel<- strftime(as.character(promise$value), "%Y-%m-%d")
      # }

      if (input$tipoPeriodo=="a" && substr(data_sel,6,7)!="01"){
          return()
      }
          
      if (input$tipoPeriodo=="t" && !substr(data_sel,6,7)%in%c("01","04","07","10")){
          return()
      }
        
      Visualizar_Grafico_Distribuicao (2, #1 - receita, 2- despesa, 3 transferências 
                                       input$tipoValor,
                                       input$tipoPeriodo,
                                       input$rubrica,
                                       FALSE,
                                       data_sel,
                                       height = 1000)

    })
    
    
    
    
  },
  
  options = list(height = 1500)
)


```



# Análise avançada

O que foi visto até agora fornece uma boa bagagem de conhecimento para entendimento de questões importantes para os debates sobre a condução da política fiscal brasileira. Pode ser útil para uma leitura mais crítica das notícias, para envolvimento em ações de controle social e até mesmo para iniciar novos estudos e projetos.

Este aplicativo também dá espaço para análises mais avançadas. Especificamente traz-se aqui leituras de comportamento das tendências de variações de receitas e também análises da sazonalidade das contas de resultado do governo central.

## Mapa de calor de tendência
O aumento ou redução das receitas está associado a aspectos diversos tais como: variações da riqueza medida pelo PIB, calendário de recebimento de tributos, acomodação a políticas econômicas domésticas e algumas vezes até mesmo reflexo de alguma tendência econômica internacional.

Para boa parte das receitas é possível fazer análises que busquem indicar curvas de tendência a partir dos dados de suas próprias série históricas. Esse é o trabalho que foi feito para gerar o mapa de calor apresentado logo abaixo. O gráfico traz a análise apenas para as receitas que se adequam a um trabalho de análise de tendência que possa de alguma forma ser útil em atividades de projeções. Valores muito fora do comportamento normal da série e que representam um ponto sem influência para cálculos de tendência foram substituídos por valores que foram calculados a partir de algoritimos de projeção, tendo como referência o comportamento da série histórica.

Para cada receita analisada é feito um cálculo que envolve a taxa de alteração da tendência entre dois meses consecutivos ponderada pela importância relativa da receita em relação à receita total. Os valores são exibidos na forma de tonalidades de cores que podem variar de um vermelho muito forte, para as valores em extremos negativos para um azul muito forte, para as valores em extremos positivos.
   
O mapa vai sempre se referir apenas ao comportamento das séries de receitas nos últimos doze meses.

```{r fig.width=10, fig.height=8}
num_meses<-12
tipo_fluxo=1#1 para receita, 2 para despesa, 3 para ambos


avalia_parc<-FALSE




rubricas<-ExtraiRubricasRaiz(1)

rubricas<-rubricas[-grep("II.",rubricas)] #Exclui as rubricas de transferência


if (mudou){
  series<- FiltraSeries(series_temporais_analise_rec,rubricas,12,avalia_parc=FALSE)

  series<- Identifica_series_estacionarias(series)

  series_tratadas<- Trata_Outlier (series)
  save("series_tratadas", file="series_tratadas.Rdata")
  
} else
{
  load("series_tratadas.Rdata")
}

series<-series_tratadas
 


serie_totalizadora <-FiltraSeries(series_temporais_analise_rec,"I. RECEITA TOTAL",12,avalia_parc)


vazio<- TRUE
nomes<- c(character())
for (i in 1:NCOL(series)){
  
  stl<-  stl(series[,i],t.window=13, s.window="periodic", robust=TRUE)
  if (sum(stl$time.series[,2]) >0){
    nomes<- c(nomes,colnames(series)[i])

    if (vazio){
      vazio<-FALSE
      decomp<-stl$time.series[,2]
      peso <- (series[,i]/serie_totalizadora)
    } else {
      decomp<- cbind(decomp,stl$time.series[,2])
      peso  <- cbind(peso,(series[,i]/serie_totalizadora))}
      
    }

}
    

diferencial<-(diff(decomp)/decomp)*peso
colnames(diferencial)<- nomes


ult_valor <- data.frame(ordem_orig = c(1:NCOL(diferencial)), valor=as.numeric(diferencial[NROW(diferencial),]))
ordem<- sort(ult_valor$valor,decreasing = TRUE)
ult_valor <- ult_valor[order(ult_valor[2]),]

diferencial<-diferencial[, c(ult_valor$ordem_orig)]


library(reshape2)
library(ggplot2)




data_fim<- max(series_temporais_analise_rec$Data)
ano_fim <- as.numeric(substr(data_fim,1,4))
mes_fim <- as.numeric(substr(data_fim,6,7))

if (mes_fim==12){
  ano_ini <- ano_fim
  mes_ini <-1
}else{
  ano_ini<- ano_fim -1
  mes_ini<- mes_fim +1
}

diferencial <- ts(diferencial[c((NROW(diferencial)-11):NROW(diferencial)),],start = c(ano_ini,mes_ini),end = c(ano_fim,mes_fim),frequency = 12)

for (i in 1:NCOL(diferencial)){
  if (i==1){
    df_series_trabalho<-data.frame(Rubricas=colnames(diferencial)[i],Data=as.character(as.yearmon(time(diferencial[,i])),format="%Y/%m"), Variacao= as.numeric(diferencial[,i]*100))
    
  } else{
    df_series_trabalho<- rbind(df_series_trabalho,data.frame(Rubricas=colnames(diferencial)[i],Data=as.character(as.yearmon(time(diferencial[,i])),format="%Y/%m"), Variacao= as.numeric(diferencial[,i]*100)))

  }
}

graph<-ggplot(df_series_trabalho, aes(df_series_trabalho$Data,df_series_trabalho$Rubricas )) +
  geom_tile(aes(fill = Variacao), color = "white") +
  scale_fill_gradient2(low = "red", high = "steelblue") +
  ylab("Rubricas ") +
  xlab("Data") +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 12),
        plot.title = element_text(size=16),
        axis.title=element_text(size=14,face="bold"),
        axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(fill = "Variacao Ponderada(%)")

library(plotly)

ggplotly(graph)


```

## Sazonalidade de Receita
O calendário influencia pode trazer influências no fluxo das receitas. O entendimento de como esses fluxos se normalmente se comportam durante um ano é importante para se poder analisar os dados que são divulgados. Por exemplo, a receita de Imposto de Renda de Pessoa Física tem um maior acúmulo no mês de Abril, quando são feitas os recolhimentos derivados das declarações do imposto de renda. É de se esperar um forte crescimento dessa receita nos meses de Abril quando comparado com o mês de março seguida de uma forte queda já no mês de Maio.

O painel abaixo mostra quatro formas diferentes de se analisar a sazonalidade das receitas. Escolha uma receita que é mais provável de ter fortes componentes sazonais, tal como **I.R. - Pessoa Física** e compare os gráficos resultantes, procurando verificar a diferença que ocorre nos meses de Abril em relação aos demais meses. Faça essa comparação preferencialmente com a opção de valores indexados pelo IPCA.

```{r}

library(shiny)
library(dygraphs)
library(data.table)
library(forecast)
library(plotly)
library(stats)
library(zoo)

load("todas_series.Rdata")
shinyApp(
  
  ui = fluidPage(
    sidebarLayout(
      sidebarPanel(
        selectInput("rubrica", "Rubricas",
                    choices = unique(series_temporais_analise_rec$Rubrica),
                    selected = series_temporais_analise_rec$Rubrica[1]
        ),
        radioButtons("tipoValor", "Tipo Valor",
                     choices = c("Indexado IPCA"="2",
                                 "Nominal"= "1")),
        downloadButton("downloadData", "Download")
        
      ),
      
      mainPanel(
        tabsetPanel(
          tabPanel("Gráfico Coordenadas Polares",plotOutput("Grafico_Polar")),
          tabPanel("Gráfico Coordenadas Cartesianas",plotlyOutput("Grafico_Cartesiano")),
          tabPanel("Gráfico Sub-Conjuntos de séries",plotlyOutput("Grafico_Sub_Series")),
          tabPanel("Gráfico Mapa de Calor", plotlyOutput("Mapa_Calor_sazonalidade"))
        )
      )
    )
  ),
  
  server = function(input, output) {
    
    output$Grafico_Polar <- renderPlot({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_rec,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      ggseasonplot(serie_sazonal, polar=TRUE) +
        ylab("R$ milhões") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      
    })
    output$Grafico_Cartesiano <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_rec,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      
      graph<-ggseasonplot(serie_sazonal, year.labels=TRUE, year.labels.left=TRUE) +
        ylab("R$ milhões") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      ggplotly(graph)
      
    })
    output$Grafico_Sub_Series <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_rec,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      graph<-ggsubseriesplot(serie_sazonal) +
        ylab("$ million") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      
  
      ggplotly(graph)
      
      
    })
    output$Mapa_Calor_sazonalidade <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_rec,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      df_series_trabalho<- data.frame(Rubrica=input$rubrica,
                                      Data=as.Date(time(serie_sazonal)), Valor = as.numeric(serie_sazonal))
      
      graph<-ggplot(df_series_trabalho, aes(substr(as.character(df_series_trabalho$Data),6,7),substr(as.character(df_series_trabalho$Data),1,4))) +
        geom_tile(aes(fill = Valor), color = "white") +
        scale_fill_gradient2(low = "#6FC8E2", high = "#7A9CBD") +
        ylab("Ano ") +
        xlab("Mês") +
        theme(legend.title = element_text(size = 10),
              legend.text = element_text(size = 12),
              plot.title = element_text(size=16),
              axis.title=element_text(size=14,face="bold"),
              axis.text.x = element_text(angle = 90, hjust = 1)) +
        labs(fill = "Valor em R$ milhões") 
      
      
      ggplotly(graph)
      
      
    })
    output$downloadData <- downloadHandler(
      filename = function() {
        
        paste("Receitas-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        Monta_Arquivo_CSV(series_temporais_analise_rec,
                          input$tipoValor,
                          "m",
                          input$rubrica,
                          FALSE,
                          file)
      }
    )
    
    
  },
  
  options = list(height = 500)
)


```

## Sazonalidade de Despesa
Tal como ocorre com as receitas, as despesas também apresentam suas séries com comportamentos sazonais. Um destaque bem evidente refere-se à **Pessoal e Encargos Sociais** que tem valores diferenciados nos meses de  Julho, Janeiro e Dezembro em decorrência da concentração das férias dos servidores públicos. Experimente essa e outras análises no painel abaixo.

```{r}

library(shiny)
library(dygraphs)
library(data.table)
library(forecast)
library(plotly)
library(stats)
library(zoo)

load("todas_series.Rdata")
shinyApp(
  
  ui = fluidPage(
    sidebarLayout(
      sidebarPanel(
        selectInput("rubrica", "Rubricas",
                    choices = unique(series_temporais_analise_desp$Rubrica),
                    selected = series_temporais_analise_rec$Rubrica[1]
        ),
        radioButtons("tipoValor", "Tipo Valor",
                     choices = c("Indexado IPCA"="2",
                                 "Nominal"= "1")),
        downloadButton("downloadData", "Download")
        
      ),
      
      mainPanel(
        tabsetPanel(
          tabPanel("Gráfico Coordenadas Polares",plotOutput("Grafico_Polar")),
          tabPanel("Gráfico Coordenadas Cartesianas",plotlyOutput("Grafico_Cartesiano")),
          tabPanel("Gráfico Sub-Conjuntos de séries",plotlyOutput("Grafico_Sub_Series")),
          tabPanel("Gráfico Mapa de Calor", plotlyOutput("Mapa_Calor_sazonalidade"))
        )
      )
    )
  ),
  
  server = function(input, output) {
    
    output$Grafico_Polar <- renderPlot({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_desp,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      ggseasonplot(serie_sazonal, polar=TRUE) +
        ylab("R$ milhões") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      
    })
    output$Grafico_Cartesiano <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_desp,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      
      graph<-ggseasonplot(serie_sazonal, year.labels=TRUE, year.labels.left=TRUE) +
        ylab("R$ milhões") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      ggplotly(graph)
      
    })
    output$Grafico_Sub_Series <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_desp,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      
      graph<-ggsubseriesplot(serie_sazonal) +
        ylab("$ million") +
        ggtitle(paste0("Gráfico de sazonalidade - ",input$rubrica))
      
  
      ggplotly(graph)
      
      
    })
    output$Mapa_Calor_sazonalidade <- renderPlotly({
      serie_sazonal<-Trata_Selecao_usuario(series_temporais_analise_desp,
                                           input$tipoValor,
                                           "m",
                                           input$rubrica,
                                           FALSE)
      df_series_trabalho<- data.frame(Rubrica=input$rubrica,
                                      Data=as.Date(time(serie_sazonal)), Valor = as.numeric(serie_sazonal))
      
      graph<-ggplot(df_series_trabalho, aes(substr(as.character(df_series_trabalho$Data),6,7),substr(as.character(df_series_trabalho$Data),1,4))) +
        geom_tile(aes(fill = Valor), color = "white") +
        scale_fill_gradient2(low = "#6FC8E2", high = "#7A9CBD") +
        ylab("Ano ") +
        xlab("Mês") +
        theme(legend.title = element_text(size = 10),
              legend.text = element_text(size = 12),
              plot.title = element_text(size=16),
              axis.title=element_text(size=14,face="bold"),
              axis.text.x = element_text(angle = 90, hjust = 1)) +
        labs(fill = "Valor em R$ milhões") 
      
      
      ggplotly(graph)
      
      
    })
    output$downloadData <- downloadHandler(
      filename = function() {
        
        paste("Despesa-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        Monta_Arquivo_CSV(series_temporais_analise_desp,
                          input$tipoValor,
                          "m",
                          input$rubrica,
                          FALSE,
                          file)
      }
    )
    
    
  },
  
  options = list(height = 500)
)


```

# Gamificação

Agora que já há um certo acúmulo de aprendizagem, que tal testar o que foi aprendido aqui aliado com a bagagem de conhecimentos anteriores? Propomos dois desafios. O primeiro está associado à capacidade de desenvolver raciocínios que possam trazer previsões sobre os próximos valores de uma dada série que compõe o resultado primário. Esse vai ser o Desafio Nastradamus. 

O segundo desafio é um quiz onde você buscará identificar que série escolhida aleatoriamente está sendo representada no gráfico. 

## Desafio Nostradamus
</BR>
![](220px-Nostradamus_Centuries_1568.jpg)
</BR>
Desafie-se a prever o próximo valor de uma série do RTN. Participe do concurso. Em breve divulgaremos aqui as regras desse desafio.


## Quiz RTN - Receita

Afinal que série de receita está representada no gráfico abaixo?
Analise o gráfico na aba **Gráfico Pergunta**, selecione a série de receita que você considera a correta e compare a imagem exibida na aba **Gráfico Resposta** com o gráfico da pergunta. Veja na aba **Metadados Pergunta** mais informações sobre a série que lhe desafiou.
Se quiser jogar novamente, pressione o botão **Nova Rodada**.
```{r}

library(shiny)
library(dygraphs)
#library(future)
library(tableHTML)
valor_inicial <- sample(1:length(rubricas),1)

ui <- fluidPage(
  tags$style(make_css(list('.dygraph-legend', 
                             
                          c('left', 'background-color'), 
                          c('70px !important', 'opaque !important')))),

  sidebarLayout(
    sidebarPanel(
      actionButton("Go", "Nova Rodada"),
      selectInput("rubrica", "Faça sua escolha",
                  choices = unique(series_temporais_analise_rec$Rubrica))
      
    ),
    mainPanel(
      
      tabsetPanel(
        tabPanel("Gráfico Pergunta",dygraphOutput("Grafico_Quiz"),  width = "100%"),
        tabPanel("Metadados Pergunta",DT::dataTableOutput("Metadados_Pergunta"))),
      
      
      tabsetPanel(
        tabPanel("Gráfico Resposta",dygraphOutput("Grafico_selecao_usuario"),  width = "100%"),
        tabPanel("Metadados Resposta",DT::dataTableOutput("Metadados_reposta")))
      
      
    )
  )
)
server <- function(input, output) {
  output$Grafico_Quiz <- renderDygraph({
    promise<-randomVals()
    print(paste("promise", promise))
    if (is.na(promise)){
      serie<-FiltraSeries (series_temporais_analise_rec, series_temporais_analise_rec$Rubrica[valor_inicial], 12,FALSE)
      GraficoSeries (serie, series_temporais_analise_rec$Rubrica[valor_inicial],series_temporais_analise_rec$Rubrica[valor_inicial],  "")
      
    } else
    {
      serie<-FiltraSeries (series_temporais_analise_rec, series_temporais_analise_rec$Rubrica[randomVals()], 12,FALSE)
      GraficoSeries (serie, series_temporais_analise_rec$Rubrica[randomVals()],series_temporais_analise_rec$Rubrica[randomVals()],  "")
      
    }  
    
    
    
  })
  output$Metadados_Pergunta <- DT::renderDataTable({
    promise<-randomVals()
    if (is.na(promise)){
      Visualiza_Metadados(series_temporais_analise_rec$Rubrica[valor_inicial],1)#1 receita
    } else{
      Visualiza_Metadados(series_temporais_analise_rec$Rubrica[randomVals()],1)#1 receita
    }
  })
  
  
  output$Grafico_selecao_usuario <- renderDygraph({
    
    serie<-FiltraSeries (series_temporais_analise_rec, input$rubrica, 12, FALSE)
    GraficoSeries (serie, input$rubrica,input$rubrica,  "")
  })
  output$Metadados_reposta <- DT::renderDataTable({
    Visualiza_Metadados(input$rubrica,1)#1 receita
  })
  randomVals <- eventReactive(input$Go, ignoreNULL = FALSE, {
    rubricas <- unique(series_temporais_analise_rec$Rubrica)
    val<-sample(1:length(rubricas),1)
    val
  })
  
}
shinyApp(ui = ui, server = server,   options = list(height = 1000)) 

```

## Quiz RTN - Despesa

Afinal que série de despesa está representada no gráfico abaixo?
```{r}


library(shiny)
library(dygraphs)
#library(future)
rubricas <- unique(series_temporais_analise_desp$Rubrica)
valor_inicial <- sample(1:length(rubricas),1)

ui <- fluidPage(
  tags$style(make_css(list('.dygraph-legend', 
                           
                           c('left', 'background-color'), 
                           c('70px !important', 'opaque !important')))),
  
  sidebarLayout(
    sidebarPanel(
      actionButton("Go", "Nova Rodada"),
      selectInput("rubrica", "Faça sua escolha",
                  choices = unique(series_temporais_analise_desp$Rubrica))
      
    ),
    mainPanel(
      
      tabsetPanel(
        tabPanel("Gráfico Pergunta",dygraphOutput("Grafico_Quiz"),  width = "100%"),
        tabPanel("Metadados Pergunta",DT::dataTableOutput("Metadados_Pergunta"))),
      
      
      tabsetPanel(
        tabPanel("Gráfico Resposta",dygraphOutput("Grafico_selecao_usuario"),  width = "100%"),
        tabPanel("Metadados Resposta",DT::dataTableOutput("Metadados_reposta")))
      
      
    )
  )
)
server <- function(input, output) {
  output$Grafico_Quiz <- renderDygraph({
    promise<-randomVals()
    if (is.na(promise)){
      serie<-FiltraSeries (series_temporais_analise_desp, series_temporais_analise_desp$Rubrica[valor_inicial], 12,FALSE)
      GraficoSeries (serie, series_temporais_analise_desp$Rubrica[valor_inicial],series_temporais_analise_desp$Rubrica[valor_inicial],  "")
      
    } else
    {
      serie<-FiltraSeries (series_temporais_analise_desp, series_temporais_analise_desp$Rubrica[randomVals()], 12,FALSE)
      GraficoSeries (serie, series_temporais_analise_desp$Rubrica[randomVals()],series_temporais_analise_desp$Rubrica[randomVals()],  "")
      
    }  
    
    
    
  })
  output$Metadados_Pergunta <- DT::renderDataTable({
    promise<-randomVals()
    if (is.na(promise)){
      Visualiza_Metadados(series_temporais_analise_desp$Rubrica[valor_inicial],2)#2 despesa
    } else{
      Visualiza_Metadados(series_temporais_analise_desp$Rubrica[randomVals()],2)#2 despesa
    }
    
    
  })
  
  
  output$Grafico_selecao_usuario <- renderDygraph({
    
    serie<-FiltraSeries (series_temporais_analise_desp, input$rubrica, 12, FALSE)
    GraficoSeries (serie, input$rubrica,input$rubrica,  "")
  })
  output$Metadados_reposta <- DT::renderDataTable({
    Visualiza_Metadados(input$rubrica,2)#2 despesa
  })
  randomVals <- eventReactive(input$Go,ignoreNULL = FALSE,{
    rubricas <- unique(series_temporais_analise_desp$Rubrica)
    val<-sample(1:length(rubricas),1)
    val
  })
  
}
shinyApp(ui = ui, server = server, options = list(height = 1000)) 


```

# Dados abertos e transparência

Este aplicativo além de trazer uma abordagem evolutiva de informações sobre o Resultado do Tesouro Nacional, é também uma experiência de transparência, principalmente pelo consumo de dados abertos e abertura de código.

Em relação a dados abertos, os dados consumidos provêm todos do [portal de dados abertos do Tesouro Transparente](http://www.tesourotransparente.gov.br/ckan/dataset). As consultas são feitas sobre dois conjuntos de dados: [Resultado Fiscal do Governo Central: Série histórica](http://www.tesourotransparente.gov.br/ckan/dataset/resultado-do-tesouro-nacional) e [Relatórios do RTN](http://www.tesourotransparente.gov.br/ckan/dataset/relatorios-do-rtn). Mais precisamente do primeiro conjunto de dados são consumidos os recursos **Resultado do Tesouro Nacional série Histórica Mensal** e **Dicionário de Conceitos e Metodologia de Cálculo**. Já em relação ao segundo conjunto de dados o aplicativo consome dinamicamente todos os relatórios do RTN. Esse consumo de dados é facilitado pelo fato dos dados estarem num repositório construído numa abordagem direcionada a dados abertos, a plataforma CKAN, que, entre outras facilidades, permite a localização dinâmica dos recursos através de uma abordagem de programação específica, o uso das chamadas APIs.

Em relação a abertura de código, optou-se por tornar disponível em toda a aplicação o botão code que permite ao usuário do aplicativo ler como o código foi escrito para gerar cada um dos gráficos e painéis.

Essa abordagem de transparência mostra como tornar viável uma ressignificação possível dos dados abertos disponibilizados à sociedade. A ressignificação, neste caso, é a transformação de uma planilha com várias abas em: 

* Diversos gráficos que transmitem conteúdos relacionados a aprendizagem; 
* Exploração de recursos razoavelmente avançados de estatística e econometria 
* Participação social 
* Interação lúdica do usuário. 

No conjunto há uma aposta de incremento de um capital técnico do público consumidor não só do ponto de vista das questões fiscais, como também de disciplinas como programação, análise de dados, visualização de dados, estatística e econometria.
