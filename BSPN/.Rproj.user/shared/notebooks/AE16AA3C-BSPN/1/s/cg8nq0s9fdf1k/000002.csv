"0","# load data in 'global' chunk so it can be shared by all users of the dashboard"
"0","library(shinyTree)"
"0","library(DT)"
"0","library(tidyr)"
"0","library(dplyr)"
"0","library(kableExtra)"
"0","library(ggplot2)"
"0","library(shiny)"
"0","load(""BP_Geral.Rdata"")"
"0","load(""PCASP_trabalho.Rdata"")"
"0","load(""contas_pcasp"")"
"0","load(""estrutura_pcasp"")"
"0","load(""esturutra_bidimensional"")"
"0","load(""BSPN_ts.Rdata"")"
"0","load(""word_cors.Rdata"")"
"0","BP_Geral$codigo<-substr(BP_Geral$conta,1,15)"
"0","#""1.1.0.0.0.00.00 - ATIVO CIRCULANTE"""
"0","#gera_DadosTabela( demonstrativo = BP_Geral, estrutura = estrutura_pcasp, dados_bruto = TRUE, rubricas_selecionadas = c(""3.1.1.0.0.00.00 - REMUNERAÇÃO A PESSOAL"") )"
"0","gera_DadosTabela<-function(rubrica_sel_num=NULL,rubrica_sel_den=NULL, demonstrativo,estrutura, div_milhao=TRUE, dados_bruto=FALSE, rubricas_selecionadas=NULL){"
"0","  demonstrativo$conta <- toupper(demonstrativo$conta)"
"0","  "
"0","  "
"0","  if (is.null(rubricas_selecionadas)){"
"0","    rubrica_sel <- c(rubrica_sel_num,rubrica_sel_den)"
"0","    rubrica_sel <- toupper(rubrica_sel)"
"0","  } else {"
"0","    rubrica_sel<- rubricas_selecionadas"
"0","  }"
"0","  "
"0","  "
"0","  demo_Filtro<-demonstrativo[demonstrativo$codigo%in%substr(rubrica_sel,1,15),c(2,3,6,7)]"
"0","  "
"0","  if (length(rubrica_sel)>1){"
"0","    if (rubrica_sel[1]!=rubrica_sel[2]){"
"0","      rubrica_sel <- factor(rubrica_sel,rubrica_sel, ordered = is.ordered(rubrica_sel))"
"0","      demo_Filtro$codigo <- factor(demo_Filtro$codigo,substr(rubrica_sel,1,15), ordered = is.ordered(substr(rubrica_sel,1,15)))"
"0","    }"
"0","    "
"0","  }"
"0","  "
"0","  "
"0","  "
"0","  demo_Filtro <- demo_Filtro %>% group_by(codigo)"
"0","  demo_Filtro <- demo_Filtro %>% arrange(codigo) "
"0","  "
"0","  "
"0","  "
"0","  if (div_milhao){ demo_Filtro$valor_consolidado <- trunc(demo_Filtro$valor_consolidado/(10^9))  }"
"0","  "
"0","  if(dados_bruto) {"
"0","    demo_Filtro<-demo_Filtro[,c(1:3)]"
"0","    names(demo_Filtro)[2]<-""conta"""
"0","    return(demo_Filtro)}"
"0","  "
"0","  "
"0","  dados_tabela<-spread(demo_Filtro,key = ""esfera"", value = ""valor_consolidado"")"
"0","  dados_tabela<- dados_tabela%>%arrange(codigo)"
"0","  dados_tabela<-dados_tabela[,c(1,3:5)]"
"0","  "
"0","  if (NROW(dados_tabela)==1){"
"0","    dados_tabela<-rbind(dados_tabela,dados_tabela)"
"0","  }"
"0","  "
"0","  "
"0","  names(dados_tabela)[1]<-""conta"""
"0","  "
"0","  "
"0","  dados_tabela <- rbind(data.frame(dados_tabela),data.frame(conta=""Quociente"",ESTADOS=dados_tabela$ESTADOS[1]/dados_tabela$ESTADOS[2], MUNICIPIOS=dados_tabela$MUNICIPIOS[1]/dados_tabela$MUNICIPIOS[2], UNIAO= dados_tabela$UNIAO[1]/dados_tabela$UNIAO[2]))"
"0","  "
"0","dados_tabela$ESTADOS[1:2]<-format(dados_tabela$ESTADOS[1:2], big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 0)"
"0","  dados_tabela$ESTADOS[3]<-paste0(format(as.numeric(dados_tabela$ESTADOS[3])*100, big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 4),""%"")"
"0","dados_tabela$MUNICIPIOS[1:2]<-format(dados_tabela$MUNICIPIOS[1:2], big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 0)"
"0","  dados_tabela$MUNICIPIOS[3]<-paste0(format(as.numeric(dados_tabela$MUNICIPIOS[3])*100, big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 4),""%"")"
"0","  "
"0","  "
"0","  dados_tabela$UNIAO[1:2]<-format(dados_tabela$UNIAO[1:2], big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 0)"
"0","  dados_tabela$UNIAO[3]<-paste0(format(as.numeric(dados_tabela$UNIAO[3])*100, big.mark = ""."", decimal.mark = "","",scientific = FALSE, digits = 4),""%"")"
"0","  "
"0","  "
"0","  names(dados_tabela)[1] <- ""Conta/Indicador"""
"0","  "
"0","  dados_tabela"
"0","  "
"0","}"
"0","geraGraficoAnalise<-function(rubrica,tipo_analise, esfera){"
"0","  "
"0","  if (tipo_analise==""V""){"
"0","    base_filtro<-estrutura_bidimensional[estrutura_bidimensional$pai==rubrica,]"
"0","    "
"0","    "
"0","    if (NROW(base_filtro)>0){"
"0","      df_av<-gera_DadosTabela(rubricas_selecionadas = c(base_filtro$filho),"
"0","                              demonstrativo =  BP_Geral,"
"0","                              estrutura =  PCASP_trabalho,"
"0","                              dados_bruto = TRUE)} "
"0","    else{"
"0","      df_av<-gera_DadosTabela(rubricas_selecionadas = c(rubrica),"
"0","                              demonstrativo =  BP_Geral,"
"0","                              estrutura =  PCASP_trabalho,"
"0","                              dados_bruto = TRUE)"
"0","    }"
"0","    "
"0","    dados_grafico<-data.frame(df_av)"
"0","    "
"0","    dados_grafico<- dados_grafico[dados_grafico$esfera %in% esfera,]"
"0","    p<-ggplot(dados_grafico, aes(fill = substr(conta,19,100), y = valor_consolidado, x = esfera)) +"
"0","      #coord_flip() +"
"0","      geom_bar(stat=""identity"", width=0.6, color = ""white"", size = 1) +"
"0","      geom_text(aes(label= ifelse(valor_consolidado == 0, """", format(round(valor_consolidado,0), big.mark = ""."", decimal.mark = "",""))),"
"0","                size = 2.5,"
"0","                hjust = 0.5,"
"0","                position = position_stack(vjust = 0.5),"
"0","                family = ""Source Sans Pro"","
"0","                color = ""grey20"") +"
"0","      scale_y_continuous(labels=function(x) {format(x, big.mark = ""."", decimal.mark="","", scientific = FALSE)}) +"
"0","      "
"0","      # scale_color_manual(values = cores_legenda) + #se fosse colocar os rótulos com as mesmas cores"
"0","      labs("
"0","        x = NULL,"
"0","        y = NULL,"
"0","        fill = ""Contas"")+"
"0","      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),"
"0","            panel.background = element_blank(), legend.position=""right"",legend.title = element_blank(),"
"0","            legend.text = element_text(size = 7))"
"0","    "
"0","    "
"0","    "
"0","    "
"0","  } else{"
"0","    BSPN_filtro<- BSPN_ts[BSPN_ts$codigo == substr(rubrica,1,15),]"
"0","    "
"0","    BSPN_filtro$valor <-  BSPN_filtro$valor/(10^3)"
"0","    "
"0","    BSPN_filtro<- BSPN_filtro[BSPN_filtro$esfera %in% esfera,]"
"0","    "
"0","    p<-ggplot(BSPN_filtro,aes(x=ano,y=valor,colour=esfera,group=esfera)) + geom_line() +"
"0","      scale_y_continuous(labels=function(x) {format(x, big.mark = ""."", decimal.mark="","", scientific = FALSE)})+"
"0","      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),"
"0","            panel.background = element_blank(), legend.position=""bottom"",legend.title = element_blank(),"
"0","            legend.text = element_text(size = 7))"
"0","  }"
"0","  "
"0","  p"
"0","  "
"0","}"
